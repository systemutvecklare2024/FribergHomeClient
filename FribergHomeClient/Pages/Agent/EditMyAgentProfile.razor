@page "/RealEstateAgents/UpdateProfile/My"
@using Blazored.LocalStorage
@using FribergHomeClient.Components
@inject HttpClient Http
@inject NotificationService NotificationService
@inject ILocalStorageService LocalStorage
@inject NavigationManager navigationManager

<PageTitle>Editera Min Profil</PageTitle>

@if (AgentDTO != null)
{
    <AgentProfileForm Agent="AgentDTO" OnSubmit="@UpdateAgentProfileCallback" SubmitButtonText="Uppdatera"></AgentProfileForm>
}

else
{
    <Spinner />
}

@code {

    private int? agentId;
    private UpdateAgentDTO AgentDTO;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        agentId = await LocalStorage.GetItemAsync<int>("AgentId");
        AgentDTO = await Http.GetFromJsonAsync<UpdateAgentDTO>($"api/RealEstateAgents/{agentId.Value}");
    }
    async Task UpdateAgentProfileCallback(UpdateAgentDTO dto)
    {
        if (!agentId.HasValue)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Ej angiven profil");
            navigationManager.NavigateTo("/RealEstateAgents/UpdateProfilee/My");
        }

        var response = await Http.PutAsJsonAsync<UpdateAgentDTO>($"api/RealEstateAgents/My", dto);

        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Success!");
            NotificationService.Notify(NotificationSeverity.Success, "Profil uppdaterad'");
            navigationManager.NavigateTo("/dashboard/myprofile");
        }
        else
        {
            Console.WriteLine("Epic failure");
            NotificationService.Notify(NotificationSeverity.Error, "Misslyckades att uppdatera din profil, försök igen");
        }
    }
}